{{define "title"}}Logs{{end}}
{{define "content"}}
<h1 class="text-2xl font-bold mb-6">Application Logs</h1>

<div class="flex flex-col sm:flex-row sm:items-center gap-3 mb-4">
    <form method="GET" action="/logs" class="flex flex-col sm:flex-row gap-2 items-stretch sm:items-center w-full sm:w-auto">
        <select name="level" class="px-3 py-2 border border-gray-300 rounded text-sm bg-white">
            <option value="">All Levels</option>
            <option value="debug" {{if eq .Level "debug"}}selected{{end}}>Debug</option>
            <option value="info" {{if eq .Level "info"}}selected{{end}}>Info</option>
            <option value="warn" {{if eq .Level "warn"}}selected{{end}}>Warn</option>
            <option value="error" {{if eq .Level "error"}}selected{{end}}>Error</option>
            <option value="fatal" {{if eq .Level "fatal"}}selected{{end}}>Fatal</option>
        </select>
        <input type="text" name="search" placeholder="Search messages..." value="{{.Search}}" class="px-3 py-2 border border-gray-300 rounded text-sm">
        <button type="submit" class="bg-gray-900 text-white px-4 py-2 rounded text-sm hover:bg-gray-800">Filter</button>
    </form>
    <div class="flex items-center justify-between sm:justify-start gap-3 sm:ml-auto">
        <span class="text-gray-500 text-sm">Total: {{.Total}}</span>
        <label class="text-sm text-gray-600 flex items-center gap-1">
            <input type="checkbox" id="live-toggle" checked> Live
        </label>
    </div>
</div>

<!-- Desktop table -->
<div class="hidden md:block overflow-x-auto">
<table class="w-full bg-white rounded-lg shadow text-sm">
    <thead>
        <tr class="bg-gray-50">
            <th class="px-3 py-2 text-left font-semibold w-[60px]">ID</th>
            <th class="px-3 py-2 text-left font-semibold w-[70px]">Level</th>
            <th class="px-3 py-2 text-left font-semibold">Message</th>
            <th class="px-3 py-2 text-left font-semibold w-[160px]">Time</th>
        </tr>
    </thead>
    <tbody id="log-body" class="divide-y divide-gray-100">
        {{range .Logs}}
        <tr>
            <td class="px-3 py-2">{{.ID}}</td>
            <td class="px-3 py-2"><span class="log-{{.Level}}">{{.Level}}</span></td>
            <td class="px-3 py-2">{{.Message}}{{if and .Fields (ne .Fields "{}")}} <span class="text-gray-500">{{.Fields}}</span>{{end}}</td>
            <td class="px-3 py-2 whitespace-nowrap">{{.CreatedAt.Format "2006-01-02 15:04:05"}}</td>
        </tr>
        {{else}}
        <tr id="no-logs-row"><td colspan="4" class="px-3 py-4 text-center text-gray-500">No logs found</td></tr>
        {{end}}
    </tbody>
</table>
</div>

<!-- Mobile cards -->
<div id="log-cards" class="md:hidden space-y-2">
    {{range .Logs}}
    <div class="bg-white rounded-lg shadow px-4 py-3">
        <div class="flex items-center justify-between mb-1">
            <span class="log-{{.Level}} text-xs font-semibold uppercase">{{.Level}}</span>
            <span class="text-xs text-gray-400">{{.CreatedAt.Format "Jan 02, 15:04:05"}}</span>
        </div>
        <div class="text-sm text-gray-800 break-words">{{.Message}}</div>
        {{if and .Fields (ne .Fields "{}")}}<div class="text-xs text-gray-400 break-all mt-1">{{.Fields}}</div>{{end}}
    </div>
    {{else}}
    <div id="no-logs-card" class="bg-white rounded-lg shadow p-6 text-center text-gray-500 text-sm">No logs found</div>
    {{end}}
</div>

{{if gt .TotalPages 1}}
<div class="flex gap-2 mt-4 justify-center flex-wrap">
    {{if gt .Page 1}}
    <a href="/logs?page={{subtract .Page 1}}&level={{.Level}}&search={{.Search}}" class="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50">Prev</a>
    {{end}}
    <span class="px-3 py-1.5 bg-gray-900 text-white rounded text-sm">{{.Page}} / {{.TotalPages}}</span>
    {{if lt .Page .TotalPages}}
    <a href="/logs?page={{add .Page 1}}&level={{.Level}}&search={{.Search}}" class="px-3 py-1.5 border border-gray-300 rounded text-sm hover:bg-gray-50">Next</a>
    {{end}}
</div>
{{end}}

<style>
.log-debug { color: #6b7280; }
.log-info { color: #0c5460; }
.log-warn { color: #92400e; }
.log-error { color: #991b1b; }
.log-fatal { color: #fff; background: #991b1b; padding: 0 0.3rem; border-radius: 2px; }
</style>

<script>
(function() {
    const toggle = document.getElementById('live-toggle');
    const tbody = document.getElementById('log-body');
    const cards = document.getElementById('log-cards');
    let es;

    function connect() {
        es = new EventSource('/api/logs/stream');
        es.onmessage = function(e) {
            const log = JSON.parse(e.data);

            // Remove "no logs" placeholders
            const noLogs = document.getElementById('no-logs-row');
            if (noLogs) noLogs.remove();
            const noLogsCard = document.getElementById('no-logs-card');
            if (noLogsCard) noLogsCard.remove();

            var fieldsStr = '';
            if (log.fields && log.fields !== '{}') {
                fieldsStr = ' <span class="text-gray-500">' + escapeHtml(log.fields) + '</span>';
            }

            // Desktop table row
            if (tbody) {
                const row = document.createElement('tr');
                row.innerHTML = '<td class="px-3 py-2">-</td>' +
                    '<td class="px-3 py-2"><span class="log-' + escapeHtml(log.level) + '">' + escapeHtml(log.level) + '</span></td>' +
                    '<td class="px-3 py-2">' + escapeHtml(log.message) + fieldsStr + '</td>' +
                    '<td class="px-3 py-2 whitespace-nowrap">' + new Date().toISOString().slice(0, 19).replace('T', ' ') + '</td>';
                tbody.insertBefore(row, tbody.firstChild);
                if (tbody.children.length > 200) tbody.removeChild(tbody.lastChild);
            }

            // Mobile card
            if (cards) {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow px-4 py-3';
                var fieldsCard = '';
                if (log.fields && log.fields !== '{}') {
                    fieldsCard = '<div class="text-xs text-gray-400 break-all mt-1">' + escapeHtml(log.fields) + '</div>';
                }
                const now = new Date();
                const timeStr = now.toLocaleString('en-US', {month:'short',day:'2-digit',hour:'2-digit',minute:'2-digit',second:'2-digit',hour12:false}).replace(',','');
                card.innerHTML = '<div class="flex items-center justify-between mb-1">' +
                    '<span class="log-' + escapeHtml(log.level) + ' text-xs font-semibold uppercase">' + escapeHtml(log.level) + '</span>' +
                    '<span class="text-xs text-gray-400">' + timeStr + '</span></div>' +
                    '<div class="text-sm text-gray-800 break-words">' + escapeHtml(log.message) + '</div>' + fieldsCard;
                cards.insertBefore(card, cards.firstChild);
                if (cards.children.length > 100) cards.removeChild(cards.lastChild);
            }
        };
        es.onerror = function() {
            es.close();
            setTimeout(connect, 3000);
        };
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    toggle.addEventListener('change', function() {
        if (this.checked) {
            connect();
        } else if (es) {
            es.close();
        }
    });

    connect();
})();
</script>
{{end}}
